# Oma moduli (H7)

Niko Hukkanen **18.5.2021**

Haaga-Helia ammattikorkeakoulu

Kurssi: [Palvelinten hallinta](https://terokarvinen.com/2021/configuration-management-systems-palvelinten-hallinta-ict4tn022-spring-2021/)

Kurssin opettaja: [Tero Karvinen](https://terokarvinen.com/contact)

Lisenssi: [GNU GENERAL PUBLIC LICENSE (3.0)](https://www.gnu.org/licenses/gpl-3.0.html)

## Harjoituksessa käytetyt laitteet ja järjestelmät

- Lenovon Legion Y540 kannettava tietokone (Intel i7-9750H CPU, RAM 16GB, Nvidia GTX 1660 Ti GPU, Host OS: Win 10 Home Versio: 20H2)
- Oracle VM VirtualBox 6.1.22.
- Salt Master: Debian 10.9.0.  
- Salt Minions: Windows 10 Home, Versio: 20H2, Debian 10.9.0, Xubuntu 20.04 LTS.

## Oman moduulin kuvaus

Moduulin tarkoituksena on hallita eri käyttöjärjestelmiä käyttäviä koneita Saltin avulla. Tässä tapauksessa kahta Linux (Debian, Xubuntu) virtuaalikonetta ja yhtä Windows 10 virtuaalikonetta, Masterina toimii Debian virtuaalikone. Uusien virtuaalikoneiden käyttöönoton tulisi helpottua Saltin ja sen tilojen avulla. Linux pohjaisille virtuaalikoneille asennetaan ohjelmia ja muokataan niiden asetuksia. Ohjelmia joiden asetuksia muokataan tässä moduulissa ovat: **Apache2** ja **UFW**. Windows 10 virtuaalikoneelle asennetaan ohjelmia ja näiden asetuksia ei tässä moduulissa muokata. 
Koneiden hallinta tapahtuu Saltin avulla käyttäen sen tiloja asentamiseen ja hallintaan.
Highstaten ja **top.sls** tiedoston avulla virtuaalikoneet ovat jaettu käyttöjärjestelmien mukaan, joten niillä ajettavia tiloja voidaan kohdentaa Windows tai Linux koneille. Tämän ansiosta yhdellä komennolla voidaan hallita kaikkia minioneita halutulla tavalla.

Asennettavia ohjelmia Linux virtuaalikoneille ovat:

 - Apache2
 - UFW
 - Htop
 - Git
 - Curl
 - Tree
 - SSH

Windows virtuaalikoneelle asennettavat ohjelmat:
 - Firefox
 - Chrome
 - Libreoffice
 - VLC
 - VScode
 - Git
 - Winrar

Ohjelmat valitsin sen mukaan, mitä olen itse joutunut käyttämään virtuaalikoneilla. Tarkoituksena olisi poistaa manuaalinen ohjelmien asentaminen, kun otetaan käyttöön uusia koneita. Tämän ansiosta uusien koneiden käyttöönotossa kuluisi vähemmän aikaa.

## Aloitus

Aloitin asentamalla täysin uudet ja puhtaat virtuaalikoneet omaa moduulia ja sen testausta varten.
Asennuksessa käytin [ohjeena](https://nikohukkanen.me/linuxpalvelimet.html#H7) aikaisempia Linux kurssin tehtäviä.
Koneina moduulissani ovat:
 - Debian 10.9.0 (master) id: debianmaster
 - Debian 10.9.0 (minion) id: debianminion
 - Xubuntu 20.04 LTS (minion) id: xubuntuminion
 - Windows 10 20H2 (minion) id : windowsminion

Liitin koneet samaan verkkoon lähiverkkoon VirtualBoxin kautta, jotta saisin virtuaalikoneiden välille yhteyden.

## Salt master
Aloitin ajamalla komennot `sudo apt-get update` ja `sudo apt-get upgrade`.
Asensin Debian masterille Salt masterin komennolla: `sudo apt-get install salt-master`.
Selvitin Debian masterin ip-osoitteen komennolla: `ip a`.
Masterin IP-osoite löytyi ja se oli **10.0.2.15**

## Salt minion
Aloitin ajamalla komennot `sudo apt-get update` ja `sudo apt-get upgrade`.
Asensin Salt minionin Debian minionille komennolla: `sudo apt-get install salt-minion`. 
Xubuntu koneelle jouduin asentamaan Curlin ja sen avulla lisäämään Salt repon. [Ohjeena](https://repo.saltstack.com/#ubuntu) käytin Saltin asennus ohjetta. Tämän jälkeen asennus tapahtui samalla komennolla kuin Debiannissa.

Windows virtuaalikoneelle jouduin asentamaan Saltin asennusohjelman avulla. Latasin sen verkostosta osoitteesta [Saltstack](https://repo.saltstack.com/index.html#windows). Windows koneilla minionin ja masterin yhteyden saa luotua helposti, kun asennusohjelmassa kysytään masterin IP-osoitetta ja samalla voidaan luoda Windows minionille oma id.

Muokkasin Salt minioneiden tietoja masterista muokkaamalla asetustiedostoja minioneilla, joka löytyy Linux koneilla polusta `/etc/salt/`. Muokkaaminen tapahtui komennolla: `sudoedit /etc/salt/minion/`.
Tiedostoon lisäsin masterin IP-osoitteen: **10.0.2.15**, tämän lisäksi annoin jokaiselle koneelle oman ID:n.

![minionsettings](https://github.com/nikhuk/palvelintenhallinta/blob/main/assets/h7/minionsettings.PNG?raw=true)

Seuraavaksi käynnistin Linux minioneiden Saltit uudelleen komennolla: `sudo systemctl restart salt-minion.service`. 
Uudelleenkäynnistyksen jälkeen ajoin komennon `sudo salt-key` masterilla. Näin sen, että minioneiden avaimet olivat saapuneet masterille.
Hyväksyin avaimet komennolla: `sudo salt-key -A`.

![saltkeys](https://github.com/nikhuk/palvelintenhallinta/blob/main/assets/h7/saltkeys.PNG?raw=true)

Avainten hyväksymisen jälkeen testasin yhteyden masterin ja minioneiden välillä käyttäen seuraavaa komentoa: `sudo salt '*' test.ping` masterilla. Kaikki minionit vastasivat testiin.

## Salt tilat

Loin Salt tiloille kansion Debian masterilla komennolla: `sudo mkdir /srv/salt`. 
Kun olin luonut kansion aloitin luomalla Windows repolle kansion ja lisäsin siihen enemmän oikeuksia komennoilla. [Ohjeena](https://nikohukkanen.me/palvelintenhallinta.html#H6) käytin aikaisempaa tehtävääni ja Teron [ohjetta](https://terokarvinen.com/2018/control-windows-with-salt) .
```
 sudo mkdir /srv/salt/win
 sudo chown root.salt /srv/salt/win
 sudo chmod ug+rwx /srv/salt/win
```
Asensin tässä vaiheessa Gitin, jotta seuraava vaihe toimisi. Käytin komentoa: `sudo apt-get -y install git`.
Tämän jälkeen otin käyttöön Saltin Windows repon komennoilla:
```
  sudo salt-run winrepo.update_git_repos
  sudo salt -G 'os:windows' pkg.refresh_db
```

![winrepo](https://github.com/nikhuk/palvelintenhallinta/blob/main/assets/h7/winrepo.PNG?raw=true)

Komentoja ajaessa huomasin sen, että Windows virtuaalikoneeni ei ollut käynnissä, kun päivitin repoja.
Käynnistin Windows virtuaalikoneen ja ajoin komennon uudelleen, jonka jälkeen se toimi.


## Windows tila

Loin kansion polkuun `/srv/salt/` komennolla: `sudo mkdir windows`.
Kansion sisälle loin **init.sls** tiedoston komennolla: `sudoedit init.sls`.
**Init.sls** tiedoston sisältö:

    vlc:
      pkg.installed
    firefox:
      pkg.installed
    winrar:
      pkg.installed
    vscode:
      pkg.installed
    libreoffice:
      pkg.installed
    chrome:
      pkg.installed
    git:
      pkg.installed
Seuraavaksi ajoin Windows tilani Windows virtuaalikoneella, tässä käytin komentoa `sudo salt 'windowsminion' state.apply windows` masterilla.

    niko@debianmaster:/srv/salt/packets$ sudo salt 'windowsminion' state.apply windows
    windowsminion:
    ----------
              ID: vlc
        Function: pkg.installed
          Result: True
         Comment: The following packages were installed/updated: vlc
         Started: 12:10:36.496481
        Duration: 41753.899 ms
         Changes:   
                  ----------
                  vlc:
                      ----------
                      new:
                          3.0.12
                      old:
    ----------
              ID: firefox
        Function: pkg.installed
          Result: False
         Comment: The following packages failed to install/update: firefox
         Started: 12:11:18.314373
        Duration: 3170.559 ms
         Changes:   
                  ----------
                  firefox:
                      Unable to locate package firefox
    ----------
              ID: winrar
        Function: pkg.installed
          Result: False
         Comment: The following packages failed to install/update: winrar
         Started: 12:11:21.549025
        Duration: 4652.484 ms
         Changes:   
                  ----------
                  winrar:
                      ----------
                      install status:
                          success
    ----------
              ID: vscode
        Function: pkg.installed
          Result: True
         Comment: The following packages were installed/updated: vscode
         Started: 12:11:26.274258
        Duration: 18890.483 ms
         Changes:   
                  ----------
                  vscode:
                      ----------
                      new:
                          1.50.1
                      old:
    ----------
              ID: libreoffice
        Function: pkg.installed
          Result: True
         Comment: The following packages were installed/updated: libreoffice
         Started: 12:11:45.212199
        Duration: 624944.146 ms
         Changes:   
                  ----------
                  libreoffice:
                      ----------
                      new:
                          7.0.3.1
                      old:
    ----------
              ID: chrome
        Function: pkg.installed
          Result: True
         Comment: The following packages were installed/updated: chrome
         Started: 12:22:10.234715
        Duration: 41248.882 ms
         Changes:   
                  ----------
                  chrome:
                      ----------
                      new:
                          68.83.32980
                      old:
    ----------
              ID: git
        Function: pkg.installed
          Result: True
         Comment: The following packages were installed/updated: git
         Started: 12:22:51.552970
        Duration: 28512.146 ms
         Changes:   
                  ----------
                  chrome:
                      ----------
                      new:
                          90.0.4430.212
                      old:
                          68.83.32980
                  git:
                      ----------
                      new:
                          2.31.1
                      old:
    
    Summary for windowsminion
    ------------
    Succeeded: 5 (changed=7)
    Failed:    2
    ------------
    Total states run:     7
    Total run time: 763.173 s
    ERROR: Minions returned with non-zero exit code

Jälleen kohtasin saman ongelman kuin aikaisemmassa harjoituksessa [(H6)](https://nikohukkanen.me/palvelintenhallinta.html#H6). WinRAR ohjelma ei ollut asentunut oikealla tavalla Saltin mukaan. Kyseinen ohjelma oli kuitenkin asennettu Windows minionille ja se löytyi C:/Program Files/WinRAR hakemistosta. Testasin tässä vaiheessa WinRAR ohjelman toimivuuden pakkaamalla ja purkamalla tiedoston. Sain testin tehtyä ja ohjelma toimi halutulla tavalla.

Firefox pakettia ei löytynyt, joten tarkistin GitHub [reposta](https://github.com/saltstack/salt-winrepo) millä nimellä Firefox löytyi sieltä. Oikea nimi Firefox paketille tässä tapauksessa oli: **firefox_x64**
Avasin Windows tilan **init.sls** tiedoston ja muokkasin sitä komennolla: `sudoedit init.sls`.

    firefox_x64:
      pkg.installed
     
Vaihdoin paketin nimen ja ajoin uudelleen Windows Salt tilan komennolla: `sudo salt 'windowsminion' state.apply windows`. 

    niko@debianmaster:/srv/salt/windows$ sudo salt 'windowsminion' state.apply windows
    windowsminion:
    ----------
              ID: vlc
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 12:37:54.287230
        Duration: 812.569 ms
         Changes:   
    ----------
              ID: firefox_x64
        Function: pkg.installed
          Result: True
         Comment: The following packages were installed/updated: firefox_x64
         Started: 12:37:55.099799
        Duration: 15766.08 ms
         Changes:   
                  ----------
                  Mozilla Maintenance Service:
                      ----------
                      new:
                          88.0.1
                      old:
                  firefox_x64:
                      ----------
                      new:
                          88.0.1
                      old:
    ----------
              ID: winrar
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 12:38:10.958544
        Duration: 3281.643 ms
         Changes:   
    ----------
              ID: vscode
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 12:38:14.240187
        Duration: 108.994 ms
         Changes:   
    ----------
              ID: libreoffice
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 12:38:14.349181
        Duration: 109.596 ms
         Changes:   
    ----------
              ID: chrome
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 12:38:14.458777
        Duration: 109.66 ms
         Changes:   
    ----------
              ID: git
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 12:38:14.568437
        Duration: 109.33 ms
         Changes:   
    
    Summary for windowsminion
    ------------
    Succeeded: 7 (changed=1)
    Failed:    0
    ------------
    Total states run:     7
    Total run time:  20.298 s

Tällä kertaa Firefox asentui minionille. Samalla huomasin sen, että Salt ei enää ilmoittanut virhettä WinRAR ohjelmasta ja sen asennuksesta, vaan sekin oli asentunut.
 ![windowsminion](https://github.com/nikhuk/palvelintenhallinta/blob/main/assets/h7/windowsminion.PNG?raw=true)

Asennetut ohjelmat löytyivät polusta `C:/Program Files/`, myös osasta ohjelmista oli tullut pikakuvakkeet työpöydälle.



## Apache tila

Tila asentaa Apache2 demonin asetusten kanssa minioneille, ja ottaa käyttöön käyttäjähakemistot, sekä vaihtaa Apachen oletussivun. Apuna käytin Teron [ohjetta](https://terokarvinen.com//2018/apache-user-homepages-automatically-salt-package-file-service-example/index.html?fromSearch=).
Aloitin asentamalla Apachen käsin Debian masterille. Asensin demonin komennolla `sudo apt-get install apache2`. Asennuksen jälkeen käynnistin Apachen uudelleen komennolla `sudo systemctl restart apache2`. Testasin  Apachen toimivuuden Curlin avulla.

    niko@debianmaster:/srv/salt$ curl localhost |grep title
      % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                     Dload  Upload   Total   Spent    Left  Speed
    100 1070    <title>Apache2 Debian Default Page: It works</title>--:--:--     0
    1  100 10701    0     0  10.2M      0 --:--:-- --:--:-- --:--:-- 10.2M
    
Apache oli lähtenyt päälle ja toimimaan. 
Seuraavaksi loin Salt tilalle kansion polkuun `/srv/salt` komennolla: `sudo mkdir apache`.
Tänne loin uuden **init.sls** tiedoston komennolla: `sudoedit init.sls`.
**init.sls** tiedoston sisältö:
```
apache2:
 pkg.installed
/var/www/html/index.html:
 file.managed:
   - source: salt://apache/default-index.html
/etc/apache2/mods-enabled/userdir.conf:
 file.symlink:
   - target: ../mods-available/userdir.conf
/etc/apache2/mods-enabled/userdir.load:
 file.symlink:
   - target: ../mods-available/userdir.load
apache2service:
 service.running:
   - name: apache2
   - watch:
     - file: /etc/apache2/mods-enabled/userdir.conf
     - file: /etc/apache2/mods-enabled/userdir.load
```
Tämän lisäksi loin samaan hakemistoon uuden tiedoston komennolla: `sudoedit default-index.html`. `default-index.html` tiedoston sisältö:

    <!DOCTYPE html>
    <html lang="fi">
    
    <head>
        <meta charset="utf-8">
        <title>Testi</title>
    </head>
    <body>
    
      <h1>Testisivusto</h1>
    
      <p>Lisää mukavia asioita löydät sivustolta <a href="https://nikohukkanen.me/">nikohukkanen.me</a></p>
    
    </body>
    </html>

Kun olin luonut tiedostot **init.sls** ja **default-index.html**, seuraavaksi poistin Apachen komennoilla: `sudo apt-get purge apache2` ja `sudo apt-get autoremove`.
Tämän jälkeen ajoin Apache Salt tilani paikallisesti komennolla: `sudo salt-call --local state.apply apache`.

    niko@debianmaster:/srv/salt/apache$ sudo salt-call --local state.apply apache
    local:
    ----------
              ID: apache2
        Function: pkg.installed
          Result: True
         Comment: The following packages were installed/updated: apache2
         Started: 16:40:49.166391
        Duration: 7092.723 ms
         Changes:   
                  ----------
                  apache2:
                      ----------
                      new:
                          2.4.38-3+deb10u4
                      old:
                  apache2-api-20120211:
                      ----------
                      new:
                          1
                      old:
                  apache2-api-20120211-openssl1.1:
                      ----------
                      new:
                          1
                      old:
                  apache2-bin:
                      ----------
                      new:
                          2.4.38-3+deb10u4
                      old:
                  apache2-data:
                      ----------
                      new:
                          2.4.38-3+deb10u4
                      old:
                  apache2-utils:
                      ----------
                      new:
                          2.4.38-3+deb10u4
                      old:
                  httpd:
                      ----------
                      new:
                          1
                      old:
                  httpd-cgi:
                      ----------
                      new:
                          1
                      old:
                  libapr1:
                      ----------
                      new:
                          1.6.5-1+b1
                      old:
                  libaprutil1:
                      ----------
                      new:
                          1.6.1-4
                      old:
                  libaprutil1-dbd-sqlite3:
                      ----------
                      new:
                          1.6.1-4
                      old:
                  libaprutil1-ldap:
                      ----------
                      new:
                          1.6.1-4
                      old:
                  ssl-cert:
                      ----------
                      new:
                          1.0.39
                      old:
    ----------
              ID: /var/www/html/index.html
        Function: file.managed
          Result: True
         Comment: File /var/www/html/index.html updated
         Started: 16:40:56.264081
        Duration: 29.418 ms
         Changes:   
                  ----------
                  diff:
                      --- 
                      +++ 
                      @@ -1,6 +1,6 @@
                       <!DOCTYPE html>
                       <html lang="fi">
                      -<html>
                      +
                       <head>
                           <meta charset="utf-8">
                           <title>Testi</title>
    ----------
              ID: /etc/apache2/mods-enabled/userdir.conf
        Function: file.symlink
          Result: True
         Comment: Created new symlink /etc/apache2/mods-enabled/userdir.conf -> ../mods-available/userdir.conf
         Started: 16:40:56.293592
        Duration: 8.363 ms
         Changes:   
                  ----------
                  new:
                      /etc/apache2/mods-enabled/userdir.conf
    ----------
              ID: /etc/apache2/mods-enabled/userdir.load
        Function: file.symlink
          Result: True
         Comment: Created new symlink /etc/apache2/mods-enabled/userdir.load -> ../mods-available/userdir.load
         Started: 16:40:56.302043
        Duration: 0.839 ms
         Changes:   
                  ----------
                  new:
                      /etc/apache2/mods-enabled/userdir.load
    ----------
              ID: apache2service
        Function: service.running
            Name: apache2
          Result: True
         Comment: Service restarted
         Started: 16:40:57.171443
        Duration: 118.862 ms
         Changes:   
                  ----------
                  apache2:
                      True
    
    Summary for local
    ------------
    Succeeded: 5 (changed=5)
    Failed:    0
    ------------
    Total states run:     5
    Total run time:   7.250 s

Testasin vielä ajaa kyseisen tilan uudelleen samalla komennolla:

    niko@debianmaster:/srv/salt/apache$ sudo salt-call --local state.apply apache
    local:
    ----------
              ID: apache2
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 16:41:33.432503
        Duration: 396.723 ms
         Changes:   
    ----------
              ID: /var/www/html/index.html
        Function: file.managed
          Result: True
         Comment: File /var/www/html/index.html is in the correct state
         Started: 16:41:33.831076
        Duration: 18.828 ms
         Changes:   
    ----------
              ID: /etc/apache2/mods-enabled/userdir.conf
        Function: file.symlink
          Result: True
         Comment: Symlink /etc/apache2/mods-enabled/userdir.conf is present and owned by root:root
         Started: 16:41:33.849987
        Duration: 0.997 ms
         Changes:   
    ----------
              ID: /etc/apache2/mods-enabled/userdir.load
        Function: file.symlink
          Result: True
         Comment: Symlink /etc/apache2/mods-enabled/userdir.load is present and owned by root:root
         Started: 16:41:33.851076
        Duration: 0.901 ms
         Changes:   
    ----------
              ID: apache2service
        Function: service.running
            Name: apache2
          Result: True
         Comment: The service apache2 is already running
         Started: 16:41:33.853109
        Duration: 21.275 ms
         Changes:   
    
    Summary for local
    ------------
    Succeeded: 5
    Failed:    0
    ------------
    Total states run:     5
    Total run time: 438.724 ms
Tilan uudelleen ajamisessa ei tapahtunut muutoksia.



## UFW tila

**Tilan tarkoitus:** Ohjelman asennus. Porttien avaus: 22, 80, 4505, 4506 tcp liikenteelle. Palomuurin käyttöönotto.
Aloitin luomalla Salt tilalle kansion polkuun `/srv/salt` komennolla: `sudo mkdir ufw`.
Tänne loin uuden **init.sls** tiedoston komennolla: `sudoedit init.sls`.
**init.sls** sisältö:

    ufw:
      pkg.installed
    'ufw allow 22/tcp':
      cmd.run:
        - unless: "sudo ufw status verbose|grep '^22/tcp '"
    'ufw allow 80/tcp':
      cmd.run:
        - unless: "sudo ufw status verbose|grep '^80/tcp '"
    'ufw allow 4505/tcp':
      cmd.run:
        - unless: "sudo ufw status verbose|grep '^4505/tcp '"
    'ufw allow 4506/tcp':
      cmd.run:
        - unless: "sudo ufw status verbose|grep '^4506/tcp '"
    'ufw enable':
      cmd.run:
        - unless: "sudo ufw enable|grep 'active'"
    ufw.service:
      service.running:
        - name: ufw
        - enable: True


Ajoin tilan paikallisesti masterilla komennolla: `sudo salt-call --local state.apply ufw`, mutta ennen tilan ajoa poistin UFW palomuurin komennolla `sudo apt-get purge ufw` ja `sudo apt-get autoremove`.

    niko@debianmaster:/srv/salt/ufw$ sudo salt-call --local state.apply ufw
    local:
    ----------
              ID: ufw
        Function: pkg.installed
          Result: True
         Comment: The following packages were installed/updated: ufw
         Started: 15:02:19.123069
        Duration: 4117.447 ms
         Changes:   
                  ----------
                  ufw:
                      ----------
                      new:
                          0.36-1
                      old:
    ----------
              ID: ufw allow 22/tcp
        Function: cmd.run
          Result: True
         Comment: Command "ufw allow 22/tcp" run
         Started: 15:02:23.244582
        Duration: 254.491 ms
         Changes:   
                  ----------
                  pid:
                      16071
                  retcode:
                      0
                  stderr:
                  stdout:
                      Rules updated
                      Rules updated (v6)
    ----------
              ID: ufw allow 80/tcp
        Function: cmd.run
          Result: True
         Comment: Command "ufw allow 80/tcp" run
         Started: 15:02:23.499269
        Duration: 235.113 ms
         Changes:   
                  ----------
                  pid:
                      16089
                  retcode:
                      0
                  stderr:
                  stdout:
                      Rules updated
                      Rules updated (v6)
    ----------
              ID: ufw allow 4505/tcp
        Function: cmd.run
          Result: True
         Comment: Command "ufw allow 4505/tcp" run
         Started: 15:02:23.734553
        Duration: 237.201 ms
         Changes:   
                  ----------
                  pid:
                      16107
                  retcode:
                      0
                  stderr:
                  stdout:
                      Rules updated
                      Rules updated (v6)
    ----------
              ID: ufw allow 4506/tcp
        Function: cmd.run
          Result: True
         Comment: Command "ufw allow 4506/tcp" run
         Started: 15:02:23.971945
        Duration: 225.48 ms
         Changes:   
                  ----------
                  pid:
                      16125
                  retcode:
                      0
                  stderr:
                  stdout:
                      Rules updated
                      Rules updated (v6)
    ----------
              ID: ufw enable
        Function: cmd.run
          Result: True
         Comment: unless condition is true
         Started: 15:02:24.197617
        Duration: 1818.084 ms
         Changes:   
    ----------
              ID: ufw.service
        Function: service.running
            Name: ufw
          Result: True
         Comment: The service ufw is already running
         Started: 15:02:26.847698
        Duration: 19.306 ms
         Changes:   
    
    Summary for local
    ------------
    Succeeded: 7 (changed=5)
    Failed:    0
    ------------
    Total states run:     7
    Total run time:   6.907 s

Ajoin tilan uudelleen paikallisesti, jotta näkisin muuttuisiko asetuksia uudelleen.

    niko@debianmaster:/srv/salt/ufw$ sudo salt-call --local state.apply ufw
    local:
    ----------
              ID: ufw
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 15:03:07.839001
        Duration: 396.674 ms
         Changes:   
    ----------
              ID: ufw allow 22/tcp
        Function: cmd.run
          Result: True
         Comment: unless condition is true
         Started: 15:03:08.236960
        Duration: 89.65 ms
         Changes:   
    ----------
              ID: ufw allow 80/tcp
        Function: cmd.run
          Result: True
         Comment: unless condition is true
         Started: 15:03:08.326817
        Duration: 86.96 ms
         Changes:   
    ----------
              ID: ufw allow 4505/tcp
        Function: cmd.run
          Result: True
         Comment: unless condition is true
         Started: 15:03:08.413965
        Duration: 86.987 ms
         Changes:   
    ----------
              ID: ufw allow 4506/tcp
        Function: cmd.run
          Result: True
         Comment: unless condition is true
         Started: 15:03:08.501159
        Duration: 87.653 ms
         Changes:   
    ----------
              ID: ufw enable
        Function: cmd.run
          Result: True
         Comment: unless condition is true
         Started: 15:03:08.589015
        Duration: 814.321 ms
         Changes:   
    ----------
              ID: ufw.service
        Function: service.running
            Name: ufw
          Result: True
         Comment: The service ufw is already running
         Started: 15:03:09.404199
        Duration: 21.454 ms
         Changes:   
    
    Summary for local
    ------------
    Succeeded: 7
    Failed:    0
    ------------
    Total states run:     7
    Total run time:   1.584 s
Tilassa ei tapahtunut muutoksia, joten tässä tapauksessa oli päästy tilaan jossa muutoksia tapahtuu vain, jos asetukset ovat muuttuneet.
Lopuksi tarkistin vielä manuaalisesti komennolla: `sudo ufw verbose`, olivatko muutokset oikeasti tapahtuneet.

    niko@debianmaster:/srv/salt/ufw$ sudo ufw verbose
    Status: active
    
    To                         Action      From
    --                         ------      ----
    22/tcp                     ALLOW       Anywhere                  
    80/tcp                     ALLOW       Anywhere                  
    4505/tcp                   ALLOW       Anywhere                  
    4506/tcp                   ALLOW       Anywhere                  
    22/tcp (v6)                ALLOW       Anywhere (v6)             
    80/tcp (v6)                ALLOW       Anywhere (v6)             
    4505/tcp (v6)              ALLOW       Anywhere (v6)             
    4506/tcp (v6)              ALLOW       Anywhere (v6)             

Muutokset olivat tapahtuneet ja palomuuri oli päällä.

## Paketti tila
Tila asentaa seuraavat ohjelmat ilman asetuksia:
 - Git
 - Curl
 - Tree
 - Htop
 - SSH

Aloitin luomalla kansion tilalle polkuun `srv/salt/` komennolla: `sudo mkdir packets`
Loin kansioon apps **init.sls** tiedoston komennolla: `sudoedit init.sls`
**init.sls** tiedoston sisältö:

    packets:
      pkg.installed:
        - pkgs:
          - curl
          - git
          - tree
          - htop
          - ssh

Seuraavaksi poistin ohjelmat: Curl, Git, Tree, SSH ja htop käyttäen komentoa: `sudo apt-get purge curl git tree htop ssh
` ja `sudo apt-get autoremove`. Tämän jälkeen ajoin Salt paketti tilani paikallisesti komennolla: `sudo salt-call --local state.apply packets`.

    niko@debianmaster:/srv/salt/packets$ sudo salt-call --local state.apply packets
    local:
    ----------
              ID: packets
        Function: pkg.installed
          Result: True
         Comment: 5 targeted packages were installed/updated.
         Started: 11:29:49.647693
        Duration: 6959.315 ms
         Changes:   
                  ----------
                  curl:
                      ----------
                      new:
                          7.64.0-4+deb10u2
                      old:
                  git:
                      ----------
                      new:
                          1:2.20.1-2+deb10u3
                      old:
                  git-completion:
                      ----------
                      new:
                          1
                      old:
                  git-core:
                      ----------
                      new:
                          1
                      old:
                  git-man:
                      ----------
                      new:
                          1:2.20.1-2+deb10u3
                      old:
                  htop:
                      ----------
                      new:
                          2.2.0-1+b1
                      old:
                  liberror-perl:
                      ----------
                      new:
                          0.17027-2
                      old:
                  openssh-client:
                      ----------
                      new:
                          1:7.9p1-10+deb10u2
                      old:
                  openssh-server:
                      ----------
                      new:
                          1:7.9p1-10+deb10u2
                      old:
                  openssh-sftp-server:
                      ----------
                      new:
                          1:7.9p1-10+deb10u2
                      old:
                  rsh-client:
                      ----------
                      new:
                          1
                      old:
                  ssh:
                      ----------
                      new:
                          1:7.9p1-10+deb10u2
                      old:
                  ssh-client:
                      ----------
                      new:
                          1
                      old:
                  ssh-server:
                      ----------
                      new:
                          1
                      old:
                  tree:
                      ----------
                      new:
                          1.8.0-1
                      old:
    
    Summary for local
    ------------
    Succeeded: 1 (changed=1)
    Failed:    0
    ------------
    Total states run:     1
    Total run time:   6.959 s

Ajoin tilan vielä uudelleen. 

    
    niko@debianmaster:/srv/salt/packets$ sudo salt-call --local state.apply packets
    local:
    ----------
              ID: packets
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 11:32:49.182273
        Duration: 429.769 ms
         Changes:   
    
    Summary for local
    ------------
    Succeeded: 1
    Failed:    0
    ------------
    Total states run:     1
    Total run time: 429.769 ms

Ohjelmat olivat asentuneet ensimmäisellä tilan ajo kerralla, eikä toisella kertaa tapahtunut mitään muutoksia.
Testasin lyhyesti asennetut ohjelmat ja ne toimivat kaikki moitteetta.

## Ylätila (Highstate top.sls)

Ylimmässä tilassa erotellaan Linux ja Windows virtuaalikoneet. Linux virtuaalikoneet (Debian, Xubuntu) erotellaan muista käyttöjärjestelmistä käytettävän kernelin avulla. Windows virtuaalikone erotellaan käyttöjärjestelmän nimen mukaan.
Kun käyttöjärjestelmät ovat eroteltu voidaan jatkossa ottaa käyttöön uusia koneita ja ajaa Highstate, jolloin se ajaa tilat halutuilla käyttöjärjestelmillä. 

**top.sls** tiedoston sisältö:

    base:
      'kernel:Linux':
        - match: grain
        - packets
        - apache
        - ufw
      'os:Windows':
        - match: grain
        - windows
Windows virtuaalikoneille ajetaan ainoastaan "windows" tila. 
Linux virtuaalikoneille ajetaan seuraavat tilat: packets, apache ja ufw.

Ajoin yhteys testin minioneiden ja masterin välillä ennen kuin, ajoin highstaten.

    niko@debianmaster:~$ sudo salt '*' test.ping
    debianminion:
        True
    xubuntuminion:
        True
    windowsminion:
        True

Kaikki minionit vastasivat testiin, ja yhteys toimi masterin ja minioneiden välillä.
Testasin highstate tilan toimivuuden ajamalla sen kaikilla virtuaalikoneilla komennolla: `sudo salt '*' state.highstate`


     niko@debianmaster:/srv/salt$ sudo salt '*' state.highstate
    xubuntuminion:
    ----------
              ID: packets
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 13:31:23.260645
        Duration: 96.349 ms
         Changes:   
    ----------
              ID: ufw
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 13:31:23.357238
        Duration: 13.845 ms
         Changes:   
    ----------
              ID: ufw allow 22/tcp
        Function: cmd.run
          Result: True
         Comment: unless condition is true
         Started: 13:31:23.373648
        Duration: 721.004 ms
         Changes:   
    ----------
              ID: ufw allow 80/tcp
        Function: cmd.run
          Result: True
         Comment: unless condition is true
         Started: 13:31:24.094924
        Duration: 95.057 ms
         Changes:   
    ----------
              ID: ufw allow 4505/tcp
        Function: cmd.run
          Result: True
         Comment: unless condition is true
         Started: 13:31:24.190408
        Duration: 97.19 ms
         Changes:   
    ----------
              ID: ufw allow 4506/tcp
        Function: cmd.run
          Result: True
         Comment: unless condition is true
         Started: 13:31:24.287889
        Duration: 97.248 ms
         Changes:   
    ----------
              ID: ufw enable
        Function: cmd.run
          Result: True
         Comment: unless condition is true
         Started: 13:31:24.385482
        Duration: 232.035 ms
         Changes:   
    ----------
              ID: ufw.service
        Function: service.running
            Name: ufw
          Result: True
         Comment: The service ufw is already running
         Started: 13:31:24.617832
        Duration: 33.205 ms
         Changes:   
    ----------
              ID: apache2
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 13:31:24.651396
        Duration: 16.898 ms
         Changes:   
    ----------
              ID: /var/www/html/index.html
        Function: file.managed
          Result: True
         Comment: File /var/www/html/index.html is in the correct state
         Started: 13:31:24.668481
        Duration: 27.025 ms
         Changes:   
    ----------
              ID: /etc/apache2/mods-enabled/userdir.conf
        Function: file.symlink
          Result: True
         Comment: Symlink /etc/apache2/mods-enabled/userdir.conf is present and owned by root:root
         Started: 13:31:24.695645
        Duration: 1.907 ms
         Changes:   
    ----------
              ID: /etc/apache2/mods-enabled/userdir.load
        Function: file.symlink
          Result: True
         Comment: Symlink /etc/apache2/mods-enabled/userdir.load is present and owned by root:root
         Started: 13:31:24.697690
        Duration: 1.765 ms
         Changes:   
    ----------
              ID: apache2service
        Function: service.running
            Name: apache2
          Result: True
         Comment: The service apache2 is already running
         Started: 13:31:24.700375
        Duration: 53.685 ms
         Changes:   
    
    Summary for xubuntuminion
    -------------
    Succeeded: 13
    Failed:     0
    -------------
    Total states run:     13
    Total run time:    1.487 s
    debianminion:
    ----------
              ID: packets
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 13:31:26.491294
        Duration: 647.307 ms
         Changes:   
    ----------
              ID: ufw
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 13:31:27.138773
        Duration: 26.458 ms
         Changes:   
    ----------
              ID: ufw allow 22/tcp
        Function: cmd.run
          Result: True
         Comment: unless condition is true
         Started: 13:31:27.167272
        Duration: 118.636 ms
         Changes:   
    ----------
              ID: ufw allow 80/tcp
        Function: cmd.run
          Result: True
         Comment: unless condition is true
         Started: 13:31:27.286121
        Duration: 102.827 ms
         Changes:   
    ----------
              ID: ufw allow 4505/tcp
        Function: cmd.run
          Result: True
         Comment: unless condition is true
         Started: 13:31:27.389192
        Duration: 106.553 ms
         Changes:   
    ----------
              ID: ufw allow 4506/tcp
        Function: cmd.run
          Result: True
         Comment: unless condition is true
         Started: 13:31:27.495972
        Duration: 107.731 ms
         Changes:   
    ----------
              ID: ufw enable
        Function: cmd.run
          Result: True
         Comment: unless condition is true
         Started: 13:31:27.603931
        Duration: 1713.782 ms
         Changes:   
    ----------
              ID: ufw.service
        Function: service.running
            Name: ufw
          Result: True
         Comment: The service ufw is already running
         Started: 13:31:29.319421
        Duration: 31.227 ms
         Changes:   
    ----------
              ID: apache2
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 13:31:29.350857
        Duration: 28.436 ms
         Changes:   
    ----------
              ID: /var/www/html/index.html
        Function: file.managed
          Result: True
         Comment: File /var/www/html/index.html is in the correct state
         Started: 13:31:29.382431
        Duration: 22.703 ms
         Changes:   
    ----------
              ID: /etc/apache2/mods-enabled/userdir.conf
        Function: file.symlink
          Result: True
         Comment: Symlink /etc/apache2/mods-enabled/userdir.conf is present and owned by root:root
         Started: 13:31:29.405290
        Duration: 1.558 ms
         Changes:   
    ----------
              ID: /etc/apache2/mods-enabled/userdir.load
        Function: file.symlink
          Result: True
         Comment: Symlink /etc/apache2/mods-enabled/userdir.load is present and owned by root:root
         Started: 13:31:29.406977
        Duration: 1.19 ms
         Changes:   
    ----------
              ID: apache2service
        Function: service.running
            Name: apache2
          Result: True
         Comment: The service apache2 is already running
         Started: 13:31:29.409295
        Duration: 26.398 ms
         Changes:   
    
    Summary for debianminion
    -------------
    Succeeded: 13
    Failed:     0
    -------------
    Total states run:     13
    Total run time:    2.935 s
    windowsminion:
    ----------
              ID: vlc
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 13:31:22.883836
        Duration: 741.348 ms
         Changes:   
    ----------
              ID: firefox_x64
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 13:31:23.625184
        Duration: 105.371 ms
         Changes:   
    ----------
              ID: winrar
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 13:31:23.730555
        Duration: 93.244 ms
         Changes:   
    ----------
              ID: vscode
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 13:31:23.823799
        Duration: 105.539 ms
         Changes:   
    ----------
              ID: libreoffice
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 13:31:23.929338
        Duration: 92.991 ms
         Changes:   
    ----------
              ID: chrome
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 13:31:24.022329
        Duration: 105.651 ms
         Changes:   
    ----------
              ID: git
        Function: pkg.installed
          Result: True
         Comment: All specified packages are already installed
         Started: 13:31:24.127980
        Duration: 92.727 ms
         Changes:   
    
    Summary for windowsminion
    ------------
    Succeeded: 7
    Failed:    0
    ------------
    Total states run:     7
    Total run time:   1.337 s

Ajoin komennon kahteen kertaan, jotta näkisin tulisiko siinä virheitä vastaan, kun kaikki on asennettu.
Salt ei ilmoittanut virheitä highstate tilaa ajaessa. 
Testasin vielä osaa asennutuista ohjelmista xubuntu minionilla.

![xubuntutest](https://github.com/nikhuk/palvelintenhallinta/blob/main/assets/h7/xubuntutesti.PNG?raw=true)

Ainakin **Apache**, **UFW**, **Curl**, **Tree** ja **Git** olivat asentuneet Salt tilojen avulla ja olivat toiminnassa. Testasin myös muut ohjelmat, jotka asensin Salt tilojen avulla Linux virtuaalikoneilla, sekä Windows virtuaalikoneella. Testeissä en huomannut virheitä tai poikkeavuuksia, joten oletan että kaikki toimivat oikealla tavalla.

## Johtopäätös

Omasta mielestäni moduulini onnistui suunnitellulla tavalla, mutta kyllähän sitä voisi parantaa jatkossa. Esimerkiksi voisi ottaa käyttöön enemmän tiloja, joissa muokataan demonien tai ohjelmien asetuksia. Ajattelin itse mahdollisesti ottaa Saltin käyttöön omissa virtuaalikoneissa ja mahdollisesti myös palvelimissa. Koen siitä olevan todella paljon hyötyä uusien koneiden käyttöönotossa ja hallinnassa.
Kurssin aikana opin paljon uutta Linuxista, sekä Saltin käytöstä. Uskon että kyseiset uudet taidot tulevat käyttöön hyvin pian itselläni

## Lähteet
- https://terokarvinen.com/2021/configuration-management-systems-palvelinten-hallinta-ict4tn022-spring-2021
- https://terokarvinen.com//2018/03/28/salt-quickstart-salt-stack-master-and-slave-on-ubuntu-linux/index.html
- https://docs.saltproject.io/en/latest/topics/windows/windows-package-manager.html
- http://terokarvinen.com/2018/control-windows-with-salt
- https://github.com/saltstack/salt-winrepo
- https://terokarvinen.com//2018/apache-user-homepages-automatically-salt-package-file-service-example/index.html
- https://docs.saltproject.io/en/latest/ref/states/all/salt.states.cmd.html
- https://docs.saltproject.io/en/latest/ref/states/all/salt.states.pkg.html
- https://docs.saltproject.io/en/latest/topics/grains/index.html#grains
- https://terokarvinen.com//2018/salt-states-i-want-my-computers-like-this/index.html
- https://docs.saltproject.io/en/latest/ref/states/top.html
- https://nikohukkanen.me